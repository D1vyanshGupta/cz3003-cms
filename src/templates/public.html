<!DOCTYPE html>
{% load staticfiles %}
<html>

<head>
  <title>Public Map</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
  <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
  <link rel="shortcut icon" type="image/png" href="{% static 'img/favicon.png' %}" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="{% static 'bootstrap/css/bootstrap.css' %}">
  <link rel="stylesheet" href="{% static 'css/base.css' %}">
  <link href="http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
  <style>
    #filters-div {
      padding: 10px;
    }

    #map {
      width: 100%;
      height: 100vh;
    }

    body {
      padding: 0px;
      margin: 0px;
    }

    .marker-content {
      width: 150px;
    }

    .filter-option {
      display: inline-block;
      margin-right: 20px;
      padding: 10px;
      border: 1px solid #c7c7c7;
      border-radius: 4px;
    }

    #haze {
      position: absolute;
      bottom: 20px;
      left: 20px;
      min-width: 100px;
      height: 160px;
      padding: 7px;
      background: rgba(250, 250, 250, 0.8);
      border-radius: 8px;

    }

    #haze table {
      text-align: center;
    }

    #haze thead {
      border-bottom: 1px solid #787878;
    }

    #haze tr,
    #haze th {
      height: 14.8257%;
      text-align: center;
    }

    #haze td {
      width: 25%;
    }
  </style>
</head>

<body>
  <div id="filters-div">
    <span class="filter-option"> Show Weather <input type="checkbox" name="filter" value="weather" checked /> </span>
    <span class="filter-option"> Show Dengue <input type="checkbox" name="filter" value="dengue" checked /> </span>
    <span class="filter-option haze-filter-option"> Show Haze <input type="checkbox" name="filter" value="haze" checked /> </span>
    <span class="filter-option"> Show Traffic Events <input type="checkbox" name="filter" value="traffic" checked /> </span>
    <span class="filter-option"> Show Terrorist Events <input type="checkbox" name="filter" value="terrorist" checked /> </span>
    <button style="vertical-align: middle;" id="refreshAPI"><i class="fa fa-refresh fa-2x"></i></button>
  </div>

  <div id="map">
  </div>
  <div id="haze">
    <table>
      <thead>
        <th> </th>
        <th> PSI </th>
        <th> PM10 </th>
        <th> PM2.5 </th>
      </thead>
      {% for haze in haze_data %}
      <tr>
        <td> {{ haze.region_name }} </td>
        <td> {{ haze.psi }} </td>
        <td> {{ haze.pm_10 }}</td>
        <td> {{ haze.pm_25 }}</td>
      </tr>
      {% endfor %}
    </table>

  </div>
  <script>
    var marker;

    function generateInfoWindowHtml(event) {
      var html = '<div class="marker-content"><p>' +
        '<strong> Reported by: </strong> ' + event['name'] + '<br/>' +
        '<strong> Description: </strong>' + event['description'] + '<br/>' +
        '<strong> Operator: </strong>' + event['operator'] + '<br/>' +
        '</p></div>';
      return html;
    }

    function initMap() {
      var mapDiv = document.getElementById('map');
      var infowindow = new google.maps.InfoWindow();
      var weatherGeoJSON, eventsGeoJSON, dengueGeoJSON;

      var map = new google.maps.Map(mapDiv, {
        center: {
          lat: 1.364922150947930,
          lng: 103.80912780761719
        },
        zoom: 11
      });

      $.ajax({
        url: '/utils/get_events_geo_JSON',
        data: {},
        dataType: 'json'
      }).done(function(data, textStatus, jqXHR) {
        eventsGeoJSON = data['geojson'];
        map.data.addGeoJson(data['geojson']);
      }).fail(function() {
        console.log('failed'); // some proper failure message
      });

      $.ajax({
        url: '/utils/get_weather_info',
        dataType: 'json'
      }).done(function(data) {
        weatherGeoJSON = data;
        map.data.addGeoJson(data);
      });

      $.ajax({
        url: '/utils/get_dengue_info',
        dataType: 'json'
      }).done(function(data) {
        dengueGeoJSON = data;
        map.data.addGeoJson(data);
      })

      map.data.addListener('click', function(event) {
        var feature = event.feature
        var iconbase = '/static/img/';
        var type = feature.getProperty('type');
        if (type == 'weather') {
          infowindow.setContent("<div style='width:170px; text-align:center;'><b>" + feature.getProperty('name') + "</b><hr style='margin:3px;'/> <img src='" + iconbase + feature.getProperty('icon') + "' height= 30px width = 30px/>  " + feature.getProperty(
            'condition_long') + "</div>");
          infowindow.setPosition(feature.getGeometry().get());
          infowindow.setOptions({
            pixelOffset: new google.maps.Size(0, -30)
          });
          infowindow.open(map);
        } else if (type == 'dengue') {
          infowindow.setContent("<div style='width:170px; text-align:center;'><b>" + feature.getProperty('locality') + "</b><hr style='margin:3px;'/> <img src='" + iconbase + 'dengue.png' + "' height= 30px width = 30px/>  Cases:" + feature.getProperty(
            'case_size') + "<br/><a target='__blank'   href='" + feature.getProperty('hyperlink') + "'>More details<a/></div>");
          var bounds = new google.maps.LatLngBounds();
          feature.getGeometry().getArray().forEach(function(path) {
            path.getArray().forEach(function(path2) {
              path2.getArray().forEach(function(latLng) {
                bounds.extend(latLng);
                console.log(latLng)
              });
            });
          });
          infowindow.setPosition(bounds.getCenter());
          infowindow.open(map);
        } else if (type == 'traffic' || type == 'terrorist') {
          var html = generateInfoWindowHtml(feature.getProperty('event'));
          infowindow.setContent(html);
          infowindow.setPosition(feature.getGeometry().get());
          infowindow.setOptions({
            pixelOffset: new google.maps.Size(0, -30)
          });
          infowindow.open(map);
        }
      });

      map.data.setStyle(function(feature) {
        var iconbase = '/static/img/';
        var type = feature.getProperty('type');
        if (type == 'weather') {
          return {
            icon: {
              url: iconbase + feature.getProperty('icon'),
              scaledSize: {
                width: 30,
                height: 30
              }
            },
            title: feature.getProperty('name') + ":" + feature.getProperty('condition_long')
          };
        }
        if (type == 'dengue') {
          if (feature.getProperty('case_size') < 10) {
            return {
              fillColor: "rgb(241, 196, 15)",
              strokeColor: "rgb(243, 156, 18)",
              strokeWeight: 2
            }
          }
          if (feature.getProperty('case_size') < 20) {
            return {
              fillColor: "rgb(230, 126, 34)",
              strokeColor: "rgb(230, 126, 34)",
              strokeWeight: 2
            }
          } else {
            return {
              fillColor: "rgb(192, 57, 43)",
              strokeColor: "rgb(192, 57, 43)",
              strokeWeight: 2
            }
          }
        } else if (type == 'traffic' || type == 'terrorist') {
          return {
            'icon': {
              url: iconbase + feature.getProperty('icon'),
              scaledSize: {
                'width': 30,
                'height': 30
              }
            }
          };
        }
      });
      $('.filter-option input[type="checkbox"]').change(function() {
        filters = [];
        map.data.forEach(function(feature) { // remove all
          map.data.remove(feature);
        });
        // add all
        map.data.addGeoJson(weatherGeoJSON);
        map.data.addGeoJson(eventsGeoJSON);
        map.data.addGeoJson(dengueGeoJSON);
        // selectively remove
        $('input[name="filter"]:checked').each(function(idx, elem) {
          filters.push($(elem).val());
        });
        map.data.forEach(function(feature) {
          if (filters.indexOf(feature.getProperty('type')) == -1) {
            map.data.remove(feature);
          }
        });
      });

      $('.haze-filter-option input[type="checkbox"]').change(function() {
        $('#haze').toggle();
      });
    }
    $(document).ready(function() {
      $('#refreshAPI').click(function() {
        $.ajax({
          url: '/utils/refreshAPI',
        }).done(function() {
          location.reload();
        })
      });
    });
  </script>
  {% include 'maps_api.html' %}
</body>

</html>
